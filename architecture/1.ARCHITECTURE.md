# System Architecture

## Overview

AI Product Research Assistant using Clean Architecture (DDD) with Milvus vector database.

```
┌─────────────────────────────────────────────────────────────────┐
│                         Client                                   │
└───────────────────────────────┬─────────────────────────────────┘
                                │ HTTP
                                ▼
┌─────────────────────────────────────────────────────────────────┐
│                     FastAPI Application                          │
│  ┌─────────────────────────────────────────────────────────────┐│
│  │ Routes: /query  /queries  /feedback  /health                ││
│  └─────────────────────────────────────────────────────────────┘│
└───────────────────────────────┬─────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────┐
│                      AI Agent Orchestrator                       │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────────────────┐ │
│  │   Router    │→ │  Executor   │→ │       Synthesizer       │ │
│  │  (LLM)      │  │ (Parallel)  │  │     (LLM Response)      │ │
│  └─────────────┘  └─────────────┘  └─────────────────────────┘ │
└───────────────────────────────┬─────────────────────────────────┘
                                │
         ┌──────────────────────┼──────────────────────┐
         │                      │                      │
         ▼                      ▼                      ▼
┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐
│  ProductRAGTool │  │  WebSearchTool  │  │PriceAnalysisTool│
│  (Milvus + RAG) │  │    (Tavily)     │  │ (Deterministic) │
└────────┬────────┘  └────────┬────────┘  └────────┬────────┘
         │                    │                    │
         ▼                    ▼                    │
┌─────────────────┐  ┌─────────────────┐          │
│     Milvus      │  │   Tavily API    │          │
│ (Vector Store)  │  │  (Web Search)   │          │
└─────────────────┘  └─────────────────┘          │
         ▲                                        │
         │                                        │
┌─────────────────┐                               │
│ Data Pipeline   │───────────────────────────────┘
│ (CSV → Embed)   │
└─────────────────┘
```

## Data Pipeline

```
CSV File → Loader → Product Entity → Embedder → Milvus
              ↓                          ↓
         LangChain              OpenAI text-embedding-3-small
         CSVLoader                   (1536 dims)
```

## Monthly Updates

Incremental update without full re-indexing:

1. Load new CSV
2. Compare product IDs with existing
3. Calculate: `to_insert`, `to_update`, `to_delete`
4. Generate embeddings only for new/updated products
5. Upsert/delete in Milvus

```python
result = await ingester.incremental_update("new_catalog.csv")
# {"inserted": 5, "updated": 10, "deleted": 2}
```

### Security
- API keys in environment variables
- CORS configuration for production
- Rate limiting (not implemented)

## Trade-offs

| Decision | Pros | Cons |
|----------|------|------|
| Milvus | Hybrid search, scalable | Complex setup |
| OpenAI | High quality | Cost, dependency |
| Sync ingestion | Simple | Blocking |
| PostgreSQL history | Reliable | Another dependency |
