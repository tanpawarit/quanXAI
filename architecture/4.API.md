# API Architecture

## Overview

The API is built using **FastAPI**, providing a high-performance, asynchronous interface for the AI Agent system. It serves as the primary gateway for frontend applications to interact with the Product Research Agent.

## Base Configuration

- **Base URL**: `http://localhost:8000`
- **Documentation**: 
  - Swagger UI: `/docs`
  - ReDoc: `/redoc`
- **CORS**: Currently configured to allow all origins (`*`) for development flexibility.

---

## Endpoints

### 1. Execute Query (`POST /query`)

The main endpoint for interacting with the AI Agent. It accepts a natural language query and returns an AI-generated response along with supporting data.

- **URL**: `/query`
- **Method**: `POST`
- **Request Body**:
  ```json
  {
    "query": "What are the top selling wireless headphones?"
  }
  ```

- **Response Body**:
  ```json
  {
    "answer": "The top selling wireless headphones are the Sony WH-1000XM5 and Bose QC45...",
    "reasoning": "User asked for top selling items. Used ProductQA agent to query sales data.",
    "agents_used": ["product_qa"],
    "products": [
      {
        "product_id": "SN-WH1000XM5",
        "name": "Sony WH-1000XM5",
        "category": "Headphones",
        "brand": "Sony",
        "price": 12990.0
      }
    ],
    "sources": [],
    "confidence": 0.95,
    "query_id": 123
  }
  ```

### 2. Query History (`GET /queries`)

Retrieves a paginated list of past queries and agent responses.

- **URL**: `/queries`
- **Method**: `GET`
- **Query Parameters**:
  - `page`: Page number (default: 1)
  - `page_size`: Items per page (default: 20)

- **Response Body**:
  ```json
  {
    "items": [
      {
        "id": 123,
        "query": "What are the top selling wireless headphones?",
        "response": "The top selling...",
        "agents_used": ["product_qa"],
        "created_at": "2023-10-27T10:00:00"
      }
    ],
    "total": 50,
    "page": 1,
    "page_size": 20
  }
  ```

### 3. Submit Feedback (`POST /feedback`)

Allows users to rate the quality of the AI's response.

- **URL**: `/feedback`
- **Method**: `POST`
- **Request Body**:
  ```json
  {
    "query_id": 123, // query id
    "rating": 5,
    "comment": "Very accurate and helpful!"
  }
  ```
- **Response Body**:
  ```json
  {
    "id": 45, // feedback id
    "query_id": 123, // query id
    "rating": 5,
    "comment": "Very accurate and helpful!",
    "created_at": "2023-10-27T10:05:00",
    "message": "Feedback submitted successfully"
  }
  ```

### 4. Health Check (`GET /health`)

Checks the operational status of the API and its dependencies (e.g., Milvus, OpenAI).

- **URL**: `/health`
- **Method**: `GET`
- **Response Body**:
  ```json
  {
    "status": "healthy",
    "version": "0.1.0",
    "components": {
      "milvus": "connected",
      "openai": "configured"
    }
  }
  ```

---

## Data Schemas

The API uses **Pydantic** models for data validation and schema definition.

### QueryRequest
| Field | Type | Description |
|-------|------|-------------|
| `query` | string | The user's question (1-1000 chars) |

### QueryResponse
| Field | Type | Description |
|-------|------|-------------|
| `answer` | string | The final natural language answer |
| `reasoning` | string | Explanation of the agent's thought process |
| `agents_used` | list[str] | List of agents involved (e.g., `["product_qa", "market_analysis"]`) |
| `products` | list[Product] | List of product entities referenced |
| `sources` | list[Source] | List of external web sources referenced |
| `confidence` | float | Confidence score (0.0 - 1.0) |
| `query_id` | int | ID for submitting feedback |

---

## File Structure

The API logic is organized within `src/application/api/`:

```
src/application/api/
├── main.py              # Application entry point & configuration
├── dependencies.py      # Dependency injection (Logger, Config)
├── schemas.py           # Pydantic models for Request/Response
└── routes/              # Route handlers
    ├── __init__.py
    ├── query.py         # /query endpoint logic
    ├── history.py       # /queries endpoint logic
    ├── feedback.py      # /feedback endpoint logic
    └── health.py        # /health endpoint logic
```
